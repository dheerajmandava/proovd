var ProovdPulse=function(){"use strict";const t=new class{constructor(){this.socket=null,this.clientId=this.getClientId(),this.websiteId=null,this.listeners=[],this.isConnecting=!1,this.retryCount=0,this.maxRetries=5,this.heartbeatInterval=null,this.socketUrl="wss://socket.proovd.in",this.debug=!1}getClientId(){const t="proovd_pulse_client_id";let e=localStorage.getItem(t);if(!e){e=this.generateUUID();try{localStorage.setItem(t,e)}catch(t){console.error("Failed to store client ID:",t)}}return e}generateUUID(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}setDebug(t){this.debug=t}log(...t){this.debug&&console.log(...t)}connect(t,e){return e&&(this.socketUrl=e),this.isConnecting?(this.log("Already connecting to socket server"),Promise.resolve(this.socket)):this.socket&&this.socket.readyState===WebSocket.OPEN?(this.log("Socket already connected"),Promise.resolve(this.socket)):(this.websiteId=t,this.isConnecting=!0,new Promise(((e,i)=>{this.disconnect();const s=`${this.socketUrl}?websiteId=${t}&clientId=${this.clientId}`;this.log("üü¢ Connecting to socket server:",s),this.socket=new WebSocket(s);const n=setTimeout((()=>{this.socket&&this.socket.readyState!==WebSocket.OPEN&&(this.socket.close(),this.isConnecting=!1,i(new Error("Connection timeout")))}),1e4);this.socket.onopen=()=>{clearTimeout(n),this.isConnecting=!1,this.retryCount=0,this.log("‚úÖ Socket connection established"),this.startHeartbeat(),this.send({type:"join",websiteId:this.websiteId,clientId:this.clientId}),e(this.socket)},this.socket.onmessage=t=>{try{const e=JSON.parse(t.data);this.log("üì© Received message:",e),this.listeners.forEach((t=>{"function"==typeof t.onMessage&&t.onMessage(e)}))}catch(t){console.error("‚ùå Error parsing message:",t)}},this.socket.onclose=t=>{clearTimeout(n),this.isConnecting=!1,this.stopHeartbeat(),this.log(`üî¥ Socket connection closed: ${t.code} ${t.reason}`),1e3!==t.code&&1001!==t.code&&this.reconnect(),this.listeners.forEach((e=>{"function"==typeof e.onDisconnect&&e.onDisconnect(t)}))},this.socket.onerror=t=>{clearTimeout(n),this.isConnecting=!1,console.error("‚ùå Socket error:",t),i(t)}})))}isConnected(){return this.socket&&this.socket.readyState===WebSocket.OPEN}send(t){if(!this.isConnected())return this.log("‚ö†Ô∏è Socket not connected, cannot send message"),!1;try{return this.socket.send(JSON.stringify(t)),!0}catch(t){return console.error("‚ùå Error sending message:",t),!1}}disconnect(){if(this.socket)try{this.stopHeartbeat(),this.socket.readyState===WebSocket.OPEN&&this.send({type:"leave",websiteId:this.websiteId,clientId:this.clientId}),this.socket.close(1e3,"Intentional disconnect"),this.socket=null}catch(t){console.error("‚ùå Error disconnecting socket:",t)}}reconnect(){if(this.retryCount>=this.maxRetries)return void this.log("‚ö†Ô∏è Maximum reconnection attempts reached");this.retryCount++;const t=Math.min(3e4,1e3*Math.pow(2,this.retryCount))+1e3*Math.random();this.log(`üü° Reconnecting in ${Math.round(t/1e3)}s (attempt ${this.retryCount}/${this.maxRetries})`),setTimeout((()=>{this.websiteId&&this.connect(this.websiteId).catch((()=>{}))}),t)}addListener(t){this.listeners.includes(t)||this.listeners.push(t)}removeListener(t){const e=this.listeners.indexOf(t);-1!==e&&this.listeners.splice(e,1),0===this.listeners.length&&this.disconnect()}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval((()=>{this.isConnected()&&this.send({type:"ping",websiteId:this.websiteId,clientId:this.clientId,timestamp:Date.now()})}),3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}trackClick(t){return this.send({type:"activity",websiteId:this.websiteId,clientId:this.clientId,metrics:{clickCount:1,scrollPercentage:t||0,timeOnPage:Math.round((Date.now()-(window.performance.timeOrigin||Date.now()))/1e3)}})}sendActivity(t,e){return this.send({type:"activity",websiteId:this.websiteId,clientId:this.clientId,metrics:{clickCount:0,scrollPercentage:t||0,timeOnPage:e||Math.round((Date.now()-(window.performance.timeOrigin||Date.now()))/1e3)}})}};console.log("üü¢ ProovdPulse Widget Script Loaded");let e=null;class i{constructor(e={}){this.options={position:"bottom-right",theme:"light",socketUrl:"wss://socket.proovd.in",updateInterval:5e3,debug:!1,...e},this.websiteId=e.websiteId,this.socketUrl=e.socketUrl||"wss://socket.proovd.in",this.activeUsers=0,this.container=null,this.pageLoadTime=Date.now(),this.activityInterval=null,this.pulseInterval=null,this.activityMetrics={scrollPercentage:0,timeOnPage:0},t.setDebug(this.options.debug),this.handleClick=this.handleClick.bind(this),this.handleScroll=this.handleScroll.bind(this),this.onMessage=this.onMessage.bind(this),t.addListener(this),console.log("üü¢ PulseWidget created with options:",this.options)}init(){return new Promise(((e,i)=>{console.log("üü¢ Initializing PulseWidget"),this.initUI(),this.startActivityTracking(),t.connect(this.websiteId,this.socketUrl).then((()=>{console.log("‚úÖ Socket connected successfully"),e()})).catch((t=>{console.error("‚ùå Socket connection failed:",t),this.activeUsers=Math.floor(5*Math.random())+1,this.updateUI(),setInterval((()=>{this.activeUsers=Math.floor(5*Math.random())+1,this.updateUI()}),this.options.updateInterval),i(t)}))}))}onMessage(t){try{"stats"===t.type&&(void 0!==t.activeUsers?(this.activeUsers=t.activeUsers,this.updateUI()):t.stats&&void 0!==t.stats.activeUsers&&(this.activeUsers=t.stats.activeUsers,this.updateUI()))}catch(t){console.error("‚ùå Error handling message:",t)}}onDisconnect(t){console.log("üî¥ Socket disconnected:",t.code,t.reason)}startActivityTracking(){console.log("üü¢ Starting activity tracking"),document.addEventListener("click",this.handleClick),document.addEventListener("scroll",this.handleScroll),this.handleScroll(),this.activityInterval=setInterval((()=>{this.activityMetrics.timeOnPage=Math.round((Date.now()-this.pageLoadTime)/1e3),t.sendActivity(this.activityMetrics.scrollPercentage,this.activityMetrics.timeOnPage)}),1e4)}handleClick(){t.trackClick(this.activityMetrics.scrollPercentage)}handleScroll(){const t=window.scrollY,e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),i=window.innerHeight;if(e>i){const s=e-i,n=Math.min(100,Math.round(t/s*100));this.activityMetrics.scrollPercentage=n}else this.activityMetrics.scrollPercentage=0}updateUI(){if(!this.container)return;const t=1===this.activeUsers?"person":"people";this.container.innerHTML=`\n      <div class="proovd-pulse-count">${this.activeUsers}</div>\n      <div class="proovd-pulse-label">${t} browsing</div>\n    `;const e=document.createElement("div");e.className="proovd-pulse-effect",this.container.appendChild(e),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),2e3)}destroy(){console.log("üü¢ Destroying PulseWidget"),document.removeEventListener("click",this.handleClick),document.removeEventListener("scroll",this.handleScroll),this.pulseInterval&&(clearInterval(this.pulseInterval),this.pulseInterval=null),this.activityInterval&&(clearInterval(this.activityInterval),this.activityInterval=null),t.removeListener(this),this.container&&this.container.parentNode&&(this.container.parentNode.removeChild(this.container),this.container=null);const e=document.getElementById("proovd-pulse-styles");e&&e.parentNode&&e.parentNode.removeChild(e),console.log("‚úÖ PulseWidget destroyed")}initUI(){this.container=document.createElement("div"),this.container.className="proovd-pulse-widget",this.container.id="proovd-pulse-widget","dark"===this.options.theme?this.container.classList.add("proovd-pulse-dark"):"auto"===this.options.theme&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&this.container.classList.add("proovd-pulse-dark"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(t=>{t.matches?this.container.classList.add("proovd-pulse-dark"):this.container.classList.remove("proovd-pulse-dark")}))),this.container.classList.add(`proovd-pulse-${this.options.position}`),this.options.zIndex&&(this.container.style.zIndex=String(this.options.zIndex)),this.updateUI(),document.body.appendChild(this.container),this.addStyles(),this.startPulseAnimation(),console.log("‚úÖ PulseWidget UI initialized")}startPulseAnimation(){this.pulseInterval&&clearInterval(this.pulseInterval),this.pulseInterval=setInterval((()=>{const t=document.querySelector(".proovd-pulse-dot");t&&(t.classList.add("pulse"),setTimeout((()=>{t&&t.classList&&t.classList.remove("pulse")}),1e3))}),2e3)}addStyles(){if(document.getElementById("proovd-pulse-styles"))return;const t=document.createElement("style");t.id="proovd-pulse-styles";const e=this.options.pulseColor||"#2563eb";t.textContent=`\n      .proovd-pulse-widget {\n        position: fixed;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;\n        font-size: 14px;\n        line-height: 1.4;\n        color: #333;\n        background-color: #fff;\n        border-radius: 12px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        padding: 10px 16px;\n        display: flex;\n        align-items: center;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        box-sizing: border-box;\n        margin: 20px;\n        min-width: 120px;\n        user-select: none;\n      }\n      \n      .proovd-pulse-dark {\n        color: #eee;\n        background-color: #333;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n      \n      .proovd-pulse-top-left {\n        top: 0;\n        left: 0;\n      }\n      \n      .proovd-pulse-top-right {\n        top: 0;\n        right: 0;\n      }\n\n      .proovd-pulse-bottom-left {\n        bottom: 0;\n        left: 0;\n      }\n      \n      .proovd-pulse-bottom-right {\n        bottom: 0;\n        right: 0;\n      }\n      \n      .proovd-pulse-content {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .proovd-pulse-dot {\n        width: 12px;\n        height: 12px;\n        background-color: ${e};\n        border-radius: 50%;\n        position: relative;\n      }\n      \n      @keyframes pulse {\n        0% {\n          transform: scale(1);\n          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);\n        }\n        \n        70% {\n          transform: scale(1.1);\n          box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);\n        }\n        \n        100% {\n          transform: scale(1);\n          box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);\n        }\n      }\n      \n      .proovd-pulse-dot.pulse {\n        animation: pulse 1s cubic-bezier(0.66, 0, 0, 1);\n      }\n      \n      .proovd-pulse-count {\n        font-weight: bold;\n        font-size: 16px;\n      }\n      \n      .proovd-pulse-label {\n        opacity: 0.8;\n        font-size: 13px;\n      }\n      \n      .proovd-pulse-widget:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);\n      }\n      \n      .proovd-pulse-dark:hover {\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\n      }\n      \n      .proovd-pulse-expanded {\n        min-width: 240px;\n        padding: 16px;\n      }\n    `,document.head.appendChild(t)}}function s(t,s={}){console.log("üü¢ ProovdPulse Widget Initializing...",{websiteId:t,options:s});try{return e&&(console.log("‚ö†Ô∏è Previous instance found, destroying it"),e.destroy(),e=null),e=new i({...s,websiteId:t}),e.init().then((()=>{console.log("‚úÖ ProovdPulse Widget initialized successfully")})).catch((t=>{console.error("‚ùå ProovdPulse Widget initialization failed:",t)})),e}catch(t){return console.error("‚ùå Failed to initialize ProovdPulse Widget:",t),null}}window.ProovdPulse={init:s,getInstance:function(){return e},version:"1.1.0"};const n=document.querySelectorAll("script[data-website-id]");if(n.length>0)try{const t=n[0],e=t.getAttribute("data-website-id"),i=t.getAttribute("data-position")||"bottom-right";if(e){console.log("üü¢ Auto-initializing ProovdPulse Widget with website ID:",e);const n={};for(const e of Array.from(t.attributes))if(e.name.startsWith("data-")&&"data-website-id"!==e.name){n[e.name.substring(5).replace(/-([a-z])/g,((t,e)=>e.toUpperCase()))]=e.value}console.log("üü¢ Auto-initialization options:",n),s(e,{position:i,...n,debug:!0})}}catch(t){console.error("‚ùå Error during auto-initialization:",t)}try{const t=document.currentScript;if(t){const e=t.src;console.log("üü¢ Current script src:",e);const i=e.match(/\/api\/websites\/([a-zA-Z0-9]+)\/pulse-widget\.js/);if(i&&i[1]){const t=i[1];console.log("üü¢ Detected websiteId from script URL:",t),s(t,{position:"bottom-right",debug:!0})}}}catch(t){console.error("‚ùå Error during URL-based initialization:",t)}let o=null;return{init:function(e,s={}){console.log("üü¢ ProovdPulse Widget Initializing...",{websiteId:e,options:s});try{return o&&(console.log("‚ö†Ô∏è ProovdPulse Widget already initialized, destroying previous instance"),o.destroy()),t.setDebug(s.debug||!1),o=new i({websiteId:e,socketUrl:s.socketUrl||"wss://socket.proovd.in",position:s.position||"bottom-right",theme:s.theme||"light",debug:s.debug||!1,updateInterval:s.updateInterval||5e3}),o.init().then((()=>{console.log("‚úÖ ProovdPulse Widget initialized successfully")})).catch((t=>{console.error("‚ùå Failed to initialize ProovdPulse Widget:",t)})),o}catch(t){return console.error("‚ùå Failed to initialize ProovdPulse Widget:",t),null}},destroy:function(){return!!o&&(o.destroy(),o=null,!0)}}}();
//# sourceMappingURL=proovd-pulse-widget.js.map
