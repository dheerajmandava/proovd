var ProovdPulse=function(t){"use strict";class e{constructor(t,e,o,i={}){this.socket=null,this.reconnectAttempts=0,this.reconnectTimeout=null,this.handlers={stats:[],connect:[],disconnect:[],error:[]},this.isConnected=!1,this.pingInterval=null,this.lastPongTime=0;const s=void 0!==i.secure?i.secure:"undefined"!=typeof window&&"https:"===window.location.protocol||o.startsWith("wss://");this.options={clientId:t,websiteId:e,serverUrl:o,secure:s,reconnectMaxAttempts:i.reconnectMaxAttempts||10,reconnectBaseDelay:i.reconnectBaseDelay||1e3,reconnectMaxDelay:i.reconnectMaxDelay||3e4,debug:i.debug||!1},this.log("Initialized with options:",this.options)}connect(){return new Promise(((t,e)=>{try{if(this.socket&&this.isConnected)return this.log("Already connected to WebSocket server"),t();0===this.reconnectAttempts&&(this.reconnectAttempts=0);const o=this.buildWebSocketUrl();this.log(`Connecting to WebSocket server: ${o}`),this.socket=new WebSocket(o),this.socket.onopen=()=>{this.log("Connected to WebSocket server"),this.isConnected=!0,this.reconnectAttempts=0,this.sendMessage("join",{clientId:this.options.clientId,websiteId:this.options.websiteId}),this.startPingInterval(),this.notifyHandlers("connect",{connected:!0}),t()},this.socket.onmessage=t=>{try{const e=JSON.parse(t.data);"stats"===e.type?this.notifyHandlers("stats",e):"pong"===e.type&&(this.lastPongTime=Date.now(),this.log("Received pong from server"))}catch(t){this.log("Error parsing message",t)}},this.socket.onclose=t=>{this.log(`Connection closed: ${t.code} ${t.reason}`),this.isConnected=!1,this.stopPingInterval(),this.notifyHandlers("disconnect",{connected:!1,code:t.code,reason:t.reason}),1e3!==t.code&&this.attemptReconnect()},this.socket.onerror=t=>{this.log("WebSocket error",t),this.notifyHandlers("error",{error:t}),e(t)}}catch(t){this.log("Failed to connect",t),this.notifyHandlers("error",{error:t}),e(t)}}))}sendActivity(t){this.sendMessage("activity",{clientId:this.options.clientId,websiteId:this.options.websiteId,metrics:t})}sendPing(){this.sendMessage("ping",{clientId:this.options.clientId,timestamp:Date.now()})}startPingInterval(){this.stopPingInterval(),this.lastPongTime=Date.now(),this.pingInterval=setInterval((()=>{if(this.isActive()){this.sendPing();Date.now()-this.lastPongTime>6e4&&(this.log("No pong received for 60 seconds, reconnecting..."),this.reconnect())}}),3e4)}stopPingInterval(){null!==this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}disconnect(){this.socket&&this.isConnected&&(this.sendMessage("leave",{clientId:this.options.clientId,websiteId:this.options.websiteId}),this.socket.close(1e3)),this.stopPingInterval(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)}reconnect(){this.socket&&this.socket.close(1001),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout((()=>{this.connect().catch((t=>{this.log("Reconnect failed",t)}))}),100)}on(t,e){this.handlers[t]||(this.handlers[t]=[]),this.handlers[t].push(e)}off(t,e){this.handlers[t]&&(this.handlers[t]=this.handlers[t].filter((t=>t!==e)))}isActive(){return this.isConnected&&this.socket?.readyState===WebSocket.OPEN}sendMessage(t,e){if(this.socket&&this.isConnected)try{this.socket.send(JSON.stringify({type:t,...e}))}catch(t){this.log("Error sending message",t)}else this.log("Cannot send message, not connected")}notifyHandlers(t,e){this.handlers[t]&&this.handlers[t].forEach((o=>{try{o(e)}catch(e){this.log(`Error in ${t} handler`,e)}}))}attemptReconnect(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);const t=this.options.reconnectMaxAttempts||5;if(this.reconnectAttempts>=t)return void this.log(`Maximum reconnect attempts (${t}) reached`);this.reconnectAttempts++;this.log(`Scheduling reconnect attempt ${this.reconnectAttempts}/${t} in 20000ms`),this.reconnectTimeout=setTimeout((()=>{this.log(`Attempting to reconnect (${this.reconnectAttempts}/${t})...`),this.connect().catch((t=>{this.log("Reconnect failed",t)}))}),2e4)}buildWebSocketUrl(){let t=this.options.serverUrl;const e=new URLSearchParams;return e.append("clientId",this.options.clientId),e.append("websiteId",this.options.websiteId),`${t}?${e.toString()}`}log(t,...e){this.options.debug&&console.log(`ProovdPulse Socket: ${t}`,...e)}}const o={container:"body",theme:"light",position:"bottom-right",showPulse:!0,pulseColor:"#4338ca",textColor:"#111827",backgroundColor:"#ffffff",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',fontSize:"14px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)",zIndex:9999};class i{constructor(t){if(this.widget=null,this.userCountElement=null,this.activeUsers=0,this.options={...o,...t},"string"==typeof this.options.container){const t=document.querySelector(this.options.container);if(!t)throw new Error(`ProovdPulse: Container element "${this.options.container}" not found`);this.container=t}else this.container=this.options.container}mount(){if(!this.widget){if(this.widget=document.createElement("div"),this.widget.className="proovd-pulse-widget",this.applyStyles(this.widget,{position:"fixed",...this.getPositionStyles(),display:"flex",alignItems:"center",padding:"8px 12px",backgroundColor:this.options.backgroundColor,color:this.options.textColor,fontFamily:this.options.fontFamily,fontSize:this.options.fontSize,borderRadius:this.options.borderRadius,boxShadow:this.options.boxShadow,zIndex:this.options.zIndex.toString(),margin:"16px",transition:"opacity 0.3s ease"}),this.options.showPulse){const t=document.createElement("div");t.className="proovd-pulse-indicator",this.applyStyles(t,{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:this.options.pulseColor,marginRight:"8px",position:"relative"});const e=document.createElement("div");e.className="proovd-pulse-animation",this.applyStyles(e,{position:"absolute",width:"100%",height:"100%",borderRadius:"50%",backgroundColor:this.options.pulseColor,opacity:"0.6",transform:"scale(1)",animation:"proovd-pulse 1.5s infinite"});const o=document.createElement("style");o.innerHTML="\n        @keyframes proovd-pulse {\n          0% {\n            transform: scale(1);\n            opacity: 0.6;\n          }\n          100% {\n            transform: scale(2.5);\n            opacity: 0;\n          }\n        }\n      ",document.head.appendChild(o),t.appendChild(e),this.widget.appendChild(t)}this.userCountElement=document.createElement("div"),this.userCountElement.className="proovd-pulse-user-count",this.updateUserCount(this.activeUsers),this.widget.appendChild(this.userCountElement),this.container.appendChild(this.widget)}}updateUserCount(t){this.activeUsers=t,this.userCountElement&&(this.userCountElement.textContent=`${t} active user${1!==t?"s":""}`)}unmount(){this.widget&&this.widget.parentNode&&(this.widget.parentNode.removeChild(this.widget),this.widget=null,this.userCountElement=null)}applyStyles(t,e){Object.entries(e).forEach((([e,o])=>{t.style[e]=o}))}getPositionStyles(){switch(this.options.position){case"top-left":return{top:"0",left:"0"};case"top-right":return{top:"0",right:"0"};case"bottom-left":return{bottom:"0",left:"0"};default:return{bottom:"0",right:"0"}}}}const s=[];for(let t=0;t<256;++t)s.push((t+256).toString(16).slice(1));let n;const r=new Uint8Array(16);var c={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function l(t,e,o){if(c.randomUUID&&!t)return c.randomUUID();const i=(t=t||{}).random??t.rng?.()??function(){if(!n){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");n=crypto.getRandomValues.bind(crypto)}return n(r)}();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=15&i[6]|64,i[8]=63&i[8]|128,function(t,e=0){return(s[t[e+0]]+s[t[e+1]]+s[t[e+2]]+s[t[e+3]]+"-"+s[t[e+4]]+s[t[e+5]]+"-"+s[t[e+6]]+s[t[e+7]]+"-"+s[t[e+8]]+s[t[e+9]]+"-"+s[t[e+10]]+s[t[e+11]]+s[t[e+12]]+s[t[e+13]]+s[t[e+14]]+s[t[e+15]]).toLowerCase()}(i)}class a{constructor(t){if(this.metrics={clickCount:0,scrollPercentage:0,timeOnPage:0},this.isTracking=!1,this.startTime=0,this.activityInterval=null,this.maxScrollPercentage=0,this.clickHandler=null,this.scrollHandler=null,this.reconnectAttempts=0,this.options={...t},this.options.clientId||(this.options.clientId=this.getClientId()),this.isProduction="undefined"!=typeof window&&("localhost"!==window.location.hostname&&!window.location.hostname.includes("127.0.0.1")),this.options.serverUrl?this.isProduction&&"ws://localhost:3001"===this.options.serverUrl&&(this.options.serverUrl="wss://socket.proovd.in"):this.options.serverUrl=this.isProduction?"wss://socket.proovd.in":"ws://localhost:3001",void 0===this.options.secure&&(this.options.secure=this.isProduction),this.maxReconnectAttempts=this.options.reconnectMaxAttempts||5,this.log("Initializing with options:",this.options),!this.options.clientId||!this.options.websiteId||!this.options.serverUrl)throw console.error("ProovdPulse: Missing required options",{clientId:this.options.clientId,websiteId:this.options.websiteId,serverUrl:this.options.serverUrl}),new Error("Missing required options for ProovdPulse initialization");this.socketClient=new e(this.options.clientId,this.options.websiteId,this.options.serverUrl,{secure:this.options.secure,debug:this.options.debug,reconnectMaxAttempts:this.options.reconnectMaxAttempts,reconnectBaseDelay:this.options.reconnectBaseDelay,reconnectMaxDelay:this.options.reconnectMaxDelay}),this.ui=new i(t),this.socketClient.on("stats",(t=>{t.websiteId===this.options.websiteId&&this.ui.updateUserCount(t.activeUsers||0)})),this.socketClient.on("connect",(()=>{this.log("Connected to ProovdPulse server")})),this.socketClient.on("disconnect",(t=>{this.log("Disconnected from ProovdPulse server",t)})),this.socketClient.on("error",(t=>{this.log("Error connecting to ProovdPulse server",t)}))}async init(){try{this.ui.mount(),await this.socketClient.connect(),this.startTracking(),this.log("Initialized successfully")}catch(t){console.error("ProovdPulse: Failed to initialize",t)}}startTracking(){this.isTracking||(this.isTracking=!0,this.startTime=Date.now(),this.clickHandler=()=>{this.metrics.clickCount+=1},document.addEventListener("click",this.clickHandler),this.scrollHandler=()=>{const t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),e=window.scrollY||document.documentElement.scrollTop,o=window.innerHeight,i=Math.min(Math.round(e/(t-o)*100),100);this.maxScrollPercentage=Math.max(i,this.maxScrollPercentage)},document.addEventListener("scroll",this.scrollHandler),this.activityInterval=window.setInterval((()=>{this.reportActivity()}),5e3),window.addEventListener("beforeunload",(()=>{this.reportActivity(),this.destroy()})))}reportActivity(){if(!this.isTracking)return;const t=Math.round((Date.now()-this.startTime)/1e3),e={clickCount:this.metrics.clickCount,scrollPercentage:this.maxScrollPercentage,timeOnPage:t};this.socketClient.sendActivity(e),this.metrics.clickCount=0}destroy(){this.isTracking=!1,null!==this.activityInterval&&(clearInterval(this.activityInterval),this.activityInterval=null),this.clickHandler&&(document.removeEventListener("click",this.clickHandler),this.clickHandler=null),this.scrollHandler&&(document.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.socketClient.disconnect(),this.ui.unmount(),this.log("Destroyed")}getClientId(){const t=localStorage.getItem("proovdPulseClientId");if(t)return t;const e=l();return localStorage.setItem("proovdPulseClientId",e),e}log(t,...e){this.options.debug&&console.log(`ProovdPulse: ${t}`,...e)}}var d=Object.freeze({__proto__:null,ProovdPulse:a});if("undefined"!=typeof window&&!window.location.href.includes("localhost")){const t=document.getElementsByTagName("script"),e=t[t.length-1];let o="";if(e&&e.src){const t=e.src.match(/\/websites\/([^\/]+)\/pulse-widget\.js/);t&&t[1]&&(o=t[1],console.log("ProovdPulse: Detected website ID:",o))}o&&(document.addEventListener("DOMContentLoaded",(async function(){try{console.log("ProovdPulse: Auto-initializing...");const{ProovdPulse:t}=await Promise.resolve().then((function(){return d}));new t({websiteId:o,debug:!0,serverUrl:"wss://socket.proovd.in",container:"body"}).init().then((()=>{console.log("ProovdPulse: Auto-initialization successful")})).catch((t=>{console.error("ProovdPulse: Auto-initialization failed:",t)}))}catch(t){console.error("ProovdPulse: Error in auto-initialization:",t)}})),"complete"!==document.readyState&&"interactive"!==document.readyState||setTimeout((async function(){try{console.log("ProovdPulse: Auto-initializing (document already loaded)...");const{ProovdPulse:t}=await Promise.resolve().then((function(){return d}));new t({websiteId:o,debug:!0,serverUrl:"wss://socket.proovd.in",container:"body"}).init().then((()=>{console.log("ProovdPulse: Direct initialization successful")})).catch((t=>{console.error("ProovdPulse: Direct initialization failed:",t)}))}catch(t){console.error("ProovdPulse: Error in direct initialization:",t)}}),500))}return t.ProovdPulse=a,t}({});
