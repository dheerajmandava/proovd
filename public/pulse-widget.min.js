var ProovdPulse=function(e){"use strict";class t{constructor(e,t,o,n={}){this.socket=null,this.reconnectAttempts=0,this.reconnectTimeout=null,this.handlers={stats:[],connect:[],disconnect:[],error:[]},this.isConnected=!1,this.pingInterval=null,this.lastPongTime=0;const s=void 0!==n.secure?n.secure:"undefined"!=typeof window&&"https:"===window.location.protocol||o.startsWith("wss://");this.options={clientId:e,websiteId:t,serverUrl:o,secure:s,reconnectMaxAttempts:n.reconnectMaxAttempts||10,reconnectDelay:n.reconnectDelay||2e4,debug:!0},console.log("üü¢ PulseSocketClient initialized with options:",this.options)}connect(){return new Promise(((e,t)=>{try{if(console.log("üü¢ Starting WebSocket connection attempt..."),this.socket&&this.isConnected)return console.log("‚úÖ Already connected to WebSocket server, reusing connection"),e();0===this.reconnectAttempts&&(this.reconnectAttempts=0);const o=this.buildWebSocketUrl();console.log(`üü¢ Connecting to WebSocket server: ${o}`);try{this.socket=new WebSocket(o),console.log("üü¢ WebSocket instance created successfully")}catch(e){return console.error("‚ùå Failed to create WebSocket instance:",e),void t(e)}this.socket.onopen=()=>{console.log("‚úÖ Connected to WebSocket server"),this.isConnected=!0,this.reconnectAttempts=0;try{this.sendMessage("join",{clientId:this.options.clientId,websiteId:this.options.websiteId}),console.log("‚úÖ Sent join message to server")}catch(e){console.error("‚ùå Failed to send join message:",e)}this.startPingInterval(),this.notifyHandlers("connect",{connected:!0}),e()},this.socket.onmessage=e=>{try{console.log("üü¢ Received message from server:",e.data);const t=JSON.parse(e.data);"stats"===t.type?(console.log("üü¢ Received stats update:",t),this.notifyHandlers("stats",t)):"pong"===t.type&&(this.lastPongTime=Date.now(),console.log("üü¢ Received pong from server"))}catch(e){console.error("‚ùå Error parsing message:",e)}},this.socket.onclose=e=>{console.log(`üî¥ Connection closed: ${e.code} ${e.reason}`),this.isConnected=!1,this.stopPingInterval(),this.notifyHandlers("disconnect",{connected:!1,code:e.code,reason:e.reason}),1e3!==e.code&&(console.log("üü° Connection closed unexpectedly, attempting to reconnect..."),this.attemptReconnect())},this.socket.onerror=e=>{console.error("‚ùå WebSocket error:",e),this.notifyHandlers("error",{error:e}),t(e)},setTimeout((()=>{this.socket&&this.socket.readyState!==WebSocket.OPEN&&!this.isConnected&&(console.error("‚ùå Connection timeout - WebSocket did not connect within 10 seconds"),this.socket.readyState===WebSocket.CONNECTING&&(console.log("üü° Socket still in CONNECTING state, closing it..."),this.socket.close(),this.socket=null),t(new Error("Connection timeout")))}),1e4)}catch(e){console.error("‚ùå Failed to connect:",e),this.notifyHandlers("error",{error:e}),t(e)}}))}sendActivity(e){console.log("üü¢ Sending activity metrics:",e),this.sendMessage("activity",{clientId:this.options.clientId,websiteId:this.options.websiteId,metrics:e})}sendPing(){console.log("üü¢ Sending ping to server"),this.sendMessage("ping",{clientId:this.options.clientId,timestamp:Date.now()})}startPingInterval(){this.stopPingInterval(),this.lastPongTime=Date.now(),console.log("üü¢ Starting ping interval (30s)"),this.pingInterval=setInterval((()=>{if(this.isActive()){this.sendPing();const e=Date.now()-this.lastPongTime;console.log(`üü¢ Time since last pong: ${Math.round(e/1e3)}s`),e>6e4&&(console.error("‚ùå No pong received for 60 seconds, reconnecting..."),this.reconnect())}else console.log("üü° Socket not active, skipping ping")}),3e4)}stopPingInterval(){null!==this.pingInterval&&(console.log("üü¢ Stopping ping interval"),clearInterval(this.pingInterval),this.pingInterval=null)}disconnect(){console.log("üü¢ Disconnecting from server..."),this.socket&&this.isConnected&&(this.sendMessage("leave",{clientId:this.options.clientId,websiteId:this.options.websiteId}),this.socket.close(1e3)),this.stopPingInterval(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)}reconnect(){console.log("üü¢ Forcing reconnection..."),this.socket&&this.socket.close(1001),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout((()=>{console.log("üü¢ Executing reconnection..."),this.connect().catch((e=>{console.error("‚ùå Reconnect failed:",e)}))}),100)}on(e,t){this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(t),console.log(`üü¢ Added handler for event type: ${e}, total handlers: ${this.handlers[e].length}`)}off(e,t){this.handlers[e]&&(this.handlers[e]=this.handlers[e].filter((e=>e!==t)),console.log(`üü¢ Removed handler for event type: ${e}, remaining handlers: ${this.handlers[e].length}`))}isActive(){return this.isConnected&&this.socket?.readyState===WebSocket.OPEN}sendMessage(e,t){if(this.socket&&this.isConnected)try{const o=JSON.stringify({type:e,...t});this.socket.send(o),console.log(`üü¢ Sent message to server: ${e}`)}catch(t){console.error(`‚ùå Error sending message: ${e}`,t)}else console.log(`üü° Cannot send message "${e}", not connected (connected: ${this.isConnected}, socket: ${this.socket?"exists":"null"})`)}notifyHandlers(e,t){this.handlers[e]&&(console.log(`üü¢ Notifying ${this.handlers[e].length} handlers for event type: ${e}`),this.handlers[e].forEach((o=>{try{o(t)}catch(t){console.error(`‚ùå Error in ${e} handler`,t)}})))}attemptReconnect(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);const e=this.options.reconnectMaxAttempts||5;if(this.reconnectAttempts>=e)return void console.log(`üü° Maximum reconnect attempts (${e}) reached, giving up`);this.reconnectAttempts++;const t=this.options.reconnectDelay||2e4;console.log(`üü° Scheduling reconnect attempt ${this.reconnectAttempts}/${e} in ${t}ms`),this.reconnectTimeout=setTimeout((()=>{console.log(`üü¢ Attempting to reconnect (${this.reconnectAttempts}/${e})...`),this.connect().catch((e=>{console.error("‚ùå Reconnect failed:",e)}))}),t)}buildWebSocketUrl(){let e=this.options.serverUrl;const t=new URLSearchParams;return t.append("clientId",this.options.clientId),t.append("websiteId",this.options.websiteId),`${e}?${t.toString()}`}log(e,...t){this.options.debug&&console.log(`ProovdPulse Socket: ${e}`,...t)}}class o{constructor(e,o,n,s={}){this.container=null,this.activeUsers=0,console.log("üü¢ Creating PulseWidget with websiteId:",o),this.clientId=e,this.websiteId=o,this.serverUrl=n,this.options={position:s.position||"bottom-right",theme:s.theme||"auto",showActiveUsers:!1!==s.showActiveUsers,showIcon:!1!==s.showIcon,zIndex:s.zIndex||999999,debug:s.debug||!1},this.socketClient=new t(e,o,n,{secure:!0,debug:this.options.debug}),this.socketClient.on("stats",this.handleStatsUpdate.bind(this)),this.socketClient.on("connect",this.handleConnect.bind(this)),this.socketClient.on("disconnect",this.handleDisconnect.bind(this)),this.socketClient.on("error",this.handleError.bind(this)),console.log("üü¢ PulseWidget created with options:",this.options)}async connect(){console.log("üü¢ PulseWidget connecting...");try{return await this.socketClient.connect(),this.initUI(),console.log("‚úÖ PulseWidget connected and UI initialized"),Promise.resolve()}catch(e){return console.error("‚ùå PulseWidget connection failed:",e),Promise.reject(e)}}initUI(){console.log("üü¢ Initializing PulseWidget UI"),this.container=document.createElement("div"),this.container.className="proovd-pulse-widget",this.container.id="proovd-pulse-widget","dark"===this.options.theme?this.container.classList.add("proovd-pulse-dark"):"auto"===this.options.theme&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&this.container.classList.add("proovd-pulse-dark"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{e.matches?this.container?.classList.add("proovd-pulse-dark"):this.container?.classList.remove("proovd-pulse-dark")}))),this.container.classList.add(`proovd-pulse-${this.options.position}`),this.options.zIndex&&(this.container.style.zIndex=String(this.options.zIndex)),this.updateUI(),document.body.appendChild(this.container),this.addStyles(),console.log("‚úÖ PulseWidget UI initialized")}updateUI(){this.container&&(this.container.innerHTML=`\n      <div class="proovd-pulse-content">\n        <div class="proovd-pulse-icon">\n          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>\n          </svg>\n        </div>\n        <div class="proovd-pulse-count">${this.activeUsers}</div>\n        <div class="proovd-pulse-label">active now</div>\n      </div>\n    `,this.container.querySelector(".proovd-pulse-content")?.addEventListener("click",(()=>{this.container?.classList.toggle("proovd-pulse-expanded")})))}addStyles(){if(document.getElementById("proovd-pulse-styles"))return;const e=document.createElement("style");e.id="proovd-pulse-styles",e.textContent='\n      .proovd-pulse-widget {\n        position: fixed;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\n        font-size: 14px;\n        line-height: 1.4;\n        color: #333;\n        background-color: #fff;\n        border-radius: 12px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        padding: 10px 16px;\n        display: flex;\n        align-items: center;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        box-sizing: border-box;\n        margin: 20px;\n        min-width: 120px;\n        user-select: none;\n      }\n      \n      .proovd-pulse-dark {\n        color: #eee;\n        background-color: #333;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n      \n      .proovd-pulse-top-left {\n        top: 0;\n        left: 0;\n      }\n      \n      .proovd-pulse-top-right {\n        top: 0;\n        right: 0;\n    }\n\n      .proovd-pulse-bottom-left {\n        bottom: 0;\n        left: 0;\n      }\n      \n      .proovd-pulse-bottom-right {\n        bottom: 0;\n        right: 0;\n      }\n      \n      .proovd-pulse-content {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .proovd-pulse-icon {\n        color: #ff4757;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .proovd-pulse-dark .proovd-pulse-icon {\n        color: #ff6b81;\n      }\n      \n      .proovd-pulse-count {\n        font-weight: bold;\n        font-size: 16px;\n      }\n      \n      .proovd-pulse-label {\n        opacity: 0.8;\n        font-size: 13px;\n      }\n      \n      .proovd-pulse-widget:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);\n      }\n      \n      .proovd-pulse-dark:hover {\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\n      }\n      \n      .proovd-pulse-expanded {\n        min-width: 240px;\n        padding: 16px;\n      }\n    ',this.options.customCSS&&(e.textContent+=this.options.customCSS),document.head.appendChild(e)}handleStatsUpdate(e){console.log("üü¢ Received stats update:",e),e&&e.stats&&"number"==typeof e.stats.activeUsers&&(this.activeUsers=e.stats.activeUsers,this.updateUI())}handleConnect(e){console.log("‚úÖ Socket connected:",e)}handleDisconnect(e){console.log("üî¥ Socket disconnected:",e)}handleError(e){console.error("‚ùå Socket error:",e)}destroy(){console.log("üü¢ Destroying PulseWidget instance"),this.socketClient.disconnect(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container);const e=document.getElementById("proovd-pulse-styles");e&&e.parentNode&&e.parentNode.removeChild(e),console.log("‚úÖ PulseWidget destroyed")}}const n="proovd_pulse_client_id";function s(){const e=localStorage.getItem(n);if(e)return console.log("üü¢ Using stored client ID:",e),e;const t=function(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}();try{localStorage.setItem(n,t),console.log("üü¢ Generated and stored new client ID:",t)}catch(e){console.error("‚ùå Failed to store client ID:",e)}return t}console.log("üü¢ ProovdPulse Widget Script Loaded");let i=null;function c(e,t={}){console.log("üü¢ ProovdPulse Widget Initializing...",{websiteId:e,options:t});try{i&&(console.log("‚ö†Ô∏è ProovdPulse Widget already initialized, destroying previous instance"),i.destroy());const n=t.clientId||s();console.log("üü¢ Using client ID:",n);const c=t.socketServer||"wss://socket.proovd.in";return console.log("üü¢ Using socket server:",c),t.debug=!0,i=new o(n,e,c,t),console.log("üü¢ Connecting to socket server..."),i.connect().then((()=>{console.log("‚úÖ ProovdPulse Widget initialized successfully")})).catch((e=>{console.error("‚ùå Failed to initialize ProovdPulse Widget:",e)})),i}catch(e){return console.error("‚ùå Failed to initialize ProovdPulse Widget:",e),null}}function r(){return i}window.ProovdPulse={init:c,getInstance:r,version:"1.0.0"},console.log("üü¢ Checking for auto-initialization...");const l=document.querySelectorAll("script[data-website-id]");if(l.length>0)try{const e=l[0],t=e.getAttribute("data-website-id"),o=e.getAttribute("data-position")||"bottom-right";if(t){console.log("üü¢ Auto-initializing ProovdPulse Widget with website ID:",t);const n={};for(const t of Array.from(e.attributes))if(t.name.startsWith("data-")&&"data-website-id"!==t.name){n[t.name.substring(5).replace(/-([a-z])/g,(e=>e[1].toUpperCase()))]=t.value}console.log("üü¢ Auto-initialization options:",n),c(t,{position:o,...n,debug:!0})}}catch(e){console.error("‚ùå Error during auto-initialization:",e)}try{const e=document.currentScript;if(e){const t=e.src;console.log("üü¢ Current script src:",t);const o=t.match(/\/p\/([a-zA-Z0-9]+)\.js$/);if(o&&o[1]){const e=o[1];console.log("üü¢ Detected websiteId from script URL:",e),c(e,{position:"bottom-right",debug:!0})}}}catch(e){console.error("‚ùå Error during URL-based initialization:",e)}return e.getInstance=r,e.init=c,e}({});
