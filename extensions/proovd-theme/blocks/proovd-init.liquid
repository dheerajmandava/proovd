{% comment %}
  Proovd A/B Testing - Initialization Block
  
  This snippet initializes the Proovd session and passes ALL active tests
  to JavaScript for product-aware price matching on any page.
{% endcomment %}

{% comment %} Get user identifier from Shopify session {% endcomment %}
{% assign proovd_id = customer.id | default: cart.token %}
{% if proovd_id == blank %}
  {% assign proovd_id = 'now' | date: '%s%N' | slice: 0, 12 %}
{% endif %}

{% comment %} Load test configuration from shop metafields {% endcomment %}
{% assign proovd_raw = shop.metafields.proovd.tests.value %}
{% assign proovd_enabled = false %}
{% assign proovd_tests = nil %}

{% comment %} Handle both structures: {tests:[...]} or [...] directly {% endcomment %}
{% if proovd_raw != blank %}
  {% if proovd_raw.tests %}
    {% assign proovd_tests = proovd_raw.tests %}
  {% elsif proovd_raw.first.id %}
    {% assign proovd_tests = proovd_raw %}
  {% endif %}
{% endif %}

{% if proovd_tests != blank %}
  {% for test in proovd_tests %}
    {% if test.status == 'active' %}
      {% assign proovd_enabled = true %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% comment %} Calculate test bucket (0-99) from user ID {% endcomment %}
{% assign proovd_hash = proovd_id | sha256 | slice: 0, 4 %}
{% assign proovd_bucket = 0 %}
{% assign hex_chars = '0123456789abcdef' %}
{% for i in (0..3) %}
  {% assign char = proovd_hash | slice: i, 1 | downcase %}
  {% assign char_idx = 0 %}
  {% for j in (0..15) %}
    {% assign hex_char = hex_chars | slice: j, 1 %}
    {% if char == hex_char %}
      {% assign char_idx = j %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% assign proovd_bucket = proovd_bucket | plus: char_idx %}
{% endfor %}
{% assign proovd_bucket = proovd_bucket | modulo: 100 %}

{% comment %} Get current product context if on product page {% endcomment %}
{% assign current_product_id = product.id | append: '' %}
{% assign current_product_handle = product.handle %}

{% comment %} Expose ALL tests to JavaScript for product-aware price matching {% endcomment %}
<script id="proovd-session" type="application/json">
{
  "id": "{{ proovd_id }}",
  "bucket": {{ proovd_bucket }},
  "enabled": {{ proovd_enabled }},
  "isCustomer": {{ customer.id | default: 'null' }},
  "currentProduct": {
    "id": "{{ current_product_id | default: '' }}",
    "handle": "{{ current_product_handle | default: '' }}"
  },
  "tests": {{ proovd_tests | json | default: '[]' }}
}
</script>

<script src="{{ 'proovd-core.js' | asset_url }}" defer></script>
<script>
  window.proovdSession = JSON.parse(document.getElementById('proovd-session').textContent);
</script>

{% schema %}
{
  "name": "Proovd Init",
  "target": "head",
  "settings": []
}
{% endschema %}
